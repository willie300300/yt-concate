Refactor code into pipeline design pattern
